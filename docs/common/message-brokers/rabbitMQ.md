## Брокеры сообщений
### RabbitMQ
Программный брокер сообщений на основе стандарта AMQP — тиражируемое связующее программное обеспечение, ориентированное 
на обработку сообщений.  

Работает на основании протокола AMQP.

#### Коротко по rabbitMQ
Основная идея модели обмена сообщениями в RabbitMQ заключается в том, что producer (издатель) не отправляет сообщения 
непосредственно в очередь. На самом деле и довольно часто издатель даже не знает, будет ли сообщение вообще доставлено 
в какую-либо очередь.

Вместо этого издатель может отправлять сообщения только на обмен. С одной стороны, обмен получает сообщения от 
издателей, а с другой — отправляет их в очереди. Обмен должен точно знать, что делать с полученным сообщением. 
Должно ли оно быть добавлено в определенную очередь? Должно ли оно быть добавлено в несколько очередей? Или 
сообщение нужно игнорировать.

В основе работы очереди лежит RPC.

#### Exchange
Обменник или точка обмена. В него отправляются сообщения. Exchange распределяет сообщение в одну или несколько очередей. 
Он маршрутизирует сообщения в очередь на основе созданных связей (bindings) между ним и очередью.

- Direct exchange — используется, когда нужно доставить сообщение в определенные очереди. Сообщение публикуется в 
обменник с определенным ключом маршрутизации и попадает во все очереди, которые связаны с этим обменником 
аналогичным ключом маршрутизации. Ключ маршрутизации — это строка. Поиск соответствия происходит при помощи 
проверки строк на эквивалентность.
- Topic exchange – аналогично direct exchange дает возможность осуществления выборочной маршрутизации путем сравнения 
ключа маршрутизации. Но, в данном случае, ключ задается по шаблону. При создании шаблона используются 0 или более 
слов (буквы AZ и az и цифры 0-9), разделенных точкой, а также символы * и #.
- Fanout exchange – все сообщения доставляются во все очереди даже если в сообщении задан ключ маршрутизации
- Headers exchange — направляет сообщения в связанные очереди на основе сравнения пар (ключ, значение) свойства 
headers привязки и аналогичного свойства сообщения. headers представляет собой Dictionary<ключ, значение>.
- Consistent-hashing exchange (exchange с согласованным хешированием) – используется, когда есть несколько очередей, 
являющихся потенциальными получателями сообщения, и когда нужно сбалансировать нагрузку между ними. Связь сообщения 
с очередью происходит по весу (условное строковое значение от 0 - n).
#### Queues
Структура данных на диске или в оперативной памяти, которая хранит ссылки на сообщения и отдает их копии consumers 
(потребителям). Queue представляет собой Erlang-процесс с состоянием (где могут кэшироваться и сами сообщения). 
1 тысяча очередей может занимать порядка 80Mb.

##### Временные 
Если создание очереди происходит с установленным параметром autoDelete, то такая очередь обретает способность 
автоматически удалять себя. Такие очереди обычно создаются в момент подключения первого клиента и удаляются в 
момент, когда все клиенты отсоединились.

Если создание очереди происходит с установленным параметром exclusive, то такая очередь разрешает подключаться 
только одному потребителю и удаляется если закроется канал. До тех пор пока канал не закроется, клиент может 
отключаться/подключаться, но только в рамках того же самого соединения. Если параметр exclusive установлен, 
то параметр autoDelete не имеет никакого эффекта.

Особенности:
- при кратковременном разрыве связи мы будем терять сообщения, которые ещё не успели дойти до потребителя
- можно поймать феномен binding churn. Феномен возникает, когда количество операций по созданию/удалению очередей и 
привязок достигает очень больших значений. В кластерном режиме такой поток операций будет расползаться по всем 
узлам и создаст большую нагрузку. Данный процесс можно оптимизировать за счет контроля количества подписок

##### Постоянные
Если создание очереди происходит с установленным параметром durable, то такая очередь сохраняет свое состояние и 
восстанавливается после перезапуска сервера/брокера. Данная очередь будет существовать до тех пор пока не будет
вызвана команду Queue.Delete.

##### Постоянные
Очереди HA требуют кластерной среды RabbitMQ. В кластерном режиме вся информация об обменниках, очередях,
привязках и потребителях будет скопирована на все узлы.

Когда сообщение публикуется в какую-то HA очередь, оно хранится на каждом узле, относящемуся к HA очереди. 
После того как сообщение потребляется на каком-то из узлов, все копии этого сообщения будут удалены на других узлах.

Очереди HA могут распространяться на все узлы в некотором кластере или только на индивидуальные.

Особенности:
- использование HA очередей приводит к наказаниям в производительности. При помещении сообщения в некую HA очередь или 
- при потреблении сообщения из HA очереди RabbitMQ должен выполнять координацию по всем узлам (2-3 узла обычно достаточно)

#### Bindings
Правило, которое сообщает обменнику в какую из очередей должны попадать сообщения

#### Шаги работы
- Издатель отправляет сообщение определенному обменнику
- Обменник, получив сообщение, маршрутизирует его в одну или несколько очередей в соответствии с правилами привязки 
между ним и очередью
- Очередь хранит ссылку на это сообщение. Само сообщение хранится в оперативной памяти или на диске
- Как только потребитель готов получить сообщение из очереди, сервер создает копию сообщения по ссылке и отправляет
- Потребитель получает сообщение и отправляет брокеру подтверждение
- Брокер, получив подтверждение, удаляет копию сообщения из очереди. Затем удаляет из оперативной памяти и с диска

#### Протокол AMQP
Открытый протокол для передачи сообщений между компонентами системы. Основная идея состоит в том, что отдельные 
подсистемы (или независимые приложения) могут обмениваться произвольным образом сообщениями через AMQP-брокер, 
который осуществляет маршрутизацию, возможно гарантирует доставку, распределение потоков данных, подписку на 
нужные типы сообщений.

##### Основные понятия
Протокол работает поверх TCP/IP.

- exchange (обменник или точка обмена) — в неё отправляются сообщения. Обменник распределяет сообщение в одну или 
несколько очередей. Он маршрутизирует сообщения в очередь на основе созданных связей (binding) между ним и очередью
- queue (очередь) — структура данных на диске или в оперативной памяти, которая хранит ссылки на сообщения и отдает 
копии сообщений consumers (потребителям). Одна очередь может использоваться несколькими потребителями
- binding (привязка) — правило, которое сообщает точке обмена в какую из очередей эти сообщения должны попадать. 
Обменник и очередь могут быть связаны несколькими привязками
